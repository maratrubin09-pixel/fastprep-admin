# Статус выполнения плана (кроме файловых сообщений)

## Из плана BUGFIX_PLAN.md:

### ❌ ФАЙЛОВЫЕ СООБЩЕНИЯ (НЕ ТРОГАЛИ, как просили):
1. ❌ Фото не пропадает из левого угла после отправки - **НЕ ИСПРАВЛЕНО** (оставили как есть)
2. ❌ Фото отправляется, но получатель не получает - **НЕ ИСПРАВЛЕНО** (оставили как есть)
3. ❌ Входящие фото не открываются - **НЕ ИСПРАВЛЕНО** (оставили как есть)

---

### ✅ ИСПРАВЛЕНО:

#### 4. ✅ Автопрокрутка не работает до нового сообщения
**Статус:** ИСПРАВЛЕНО ✅
- Использован `requestAnimationFrame` для синхронизации с рендерингом
- Улучшены таймауты (50ms и 200ms)
- Двойной подход: `scrollTop` + `scrollIntoView`
- Прокрутка только если пользователь уже внизу

**Файл:** `frontend/src/pages/InboxPage.js` (строки 347-376, 430-455)

---

### ✅ УЖЕ БЫЛО В КОДЕ (проверено):

#### 5. ❓ Новый чат определяется как "Unknown"
**Статус:** КОД УЖЕ ЕСТЬ, должен работать ✅

**Что уже реализовано:**

1. **В `telegram.service.ts` (метод `processIncomingMessage`):**
   - Строки 248-358: Улучшенная логика получения `chatTitle` и `senderName` с 4 способами:
     - Способ 1: Из `message._sender` (самый быстрый)
     - Способ 2: Через `getEntity` для chatId
     - Способ 3: Через `getEntity` для senderId отдельно
     - Способ 4: Fallback на username, phone или chatId
   - Приоритет: имя > username > phone > fallback

2. **В `inbox.service.ts` (метод `findOrCreateThread`):**
   - Строки 216-241: Логика обновления `chat_title` с приоритетами:
     - Полное имя = приоритет 3 (высший)
     - Телефон = приоритет 2
     - Username/@chat = приоритет 1 (низкий)
     - Unknown = приоритет 0
   - Обновляет `chat_title` если новое значение лучше старого
   - Обновляет если старое было "Unknown"

**Должно работать**, но если не работает:
- Возможно проблема с получением entity из Telegram API
- Или entity получается, но слишком поздно

**Что можно улучшить (если не работает):**
- Добавить retry логику для получения entity
- Добавить логирование для диагностики
- Сохранять информацию о пользователе при первом сообщении

---

#### ✅ Сортировка чатов по `last_message_at`
**Статус:** УЖЕ РАБОТАЕТ ✅

**Что уже реализовано:**
- В `InboxPage.js` (строки 310-315): Сортировка при обновлении списка чатов
- Сортирует по `last_message_at` (более свежие сверху)
- Обновляется при получении новых сообщений через WebSocket

---

## ИТОГО:

### Выполнено:
- ✅ Автопрокрутка - исправлено

### Уже было (должно работать):
- ✅ Сортировка чатов - работает
- ✅ Unknown чаты - код есть, должен работать (если не работает - нужно проверить логи)

### Не трогали (как просили):
- ❌ Все проблемы с файловыми сообщениями

---

## Что еще можно сделать (если Unknown чаты не работают):

1. **Добавить логирование** в `processIncomingMessage`:
   - Логировать каждый способ получения информации
   - Логировать финальный `chatTitle`
   - Логировать результат обновления в `findOrCreateThread`

2. **Добавить retry логику** для получения entity из Telegram API

3. **Улучшить сохранение информации** при первом сообщении

