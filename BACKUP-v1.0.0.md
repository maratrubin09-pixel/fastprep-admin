# Backup Instructions - v1.0.0 (Telegram Working)

**Date:** October 26, 2025  
**Status:** ✅ WORKING - Telegram integration + Unified Inbox  
**Git Commit:** `80d3446` (main branch)  
**Git Tag:** `v1.0.0-telegram-working`

---

## What's Working

- ✅ Telegram integration via gramjs
- ✅ Worker receives messages from Telegram
- ✅ Messages saved to PostgreSQL database
- ✅ Unified Inbox UI displays messages with text
- ✅ Service-to-service authentication via SERVICE_JWT
- ✅ JWT authentication for users
- ✅ Authorization with PepGuard
- ✅ WhatsApp integration (Baileys)

---

## Critical Files to Backup

### 1. Git Repository
```bash
git clone https://github.com/maratrubin09-pixel/fastprep-admin.git
git checkout v1.0.0-telegram-working
```

### 2. Environment Variables

**fastprep-admin-api:**
```
NODE_ENV=production
DATABASE_URL=<from render>
REDIS_URL=<from render>
JWT_SECRET=<auto-generated by render>
TG_API_ID=<your telegram api id>
TG_API_HASH=<your telegram api hash>
SERVICE_JWT=fd67e0e2580538bb47a4641688a78df41015f14a4dcfb0f567373ab3c14b5479
S3_BUCKET=<your s3 bucket>
S3_REGION=<your s3 region>
S3_ACCESS_KEY_ID=<your s3 key>
S3_SECRET_ACCESS_KEY=<your s3 secret>
S3_ENDPOINT=<your s3 endpoint>
```

**fastprep-admin-worker:**
```
NODE_ENV=production
IS_WORKER=true
DATABASE_URL=<from render>
REDIS_URL=<from render>
TG_API_ID=<your telegram api id>
TG_API_HASH=<your telegram api hash>
TG_PHONE_NUMBER=<your telegram phone>
TDLIB_DIR=/var/data/tdlib
TDLIB_ENCRYPTION_KEY=<your encryption key>
SERVICE_JWT=fd67e0e2580538bb47a4641688a78df41015f14a4dcfb0f567373ab3c14b5479
BACKEND_URL=https://fastprep-admin-api.onrender.com
FAIL_ALERT_COOLDOWN_SEC=300
FAIL_ALERT_THRESHOLD=5
FAIL_ALERT_WINDOW_SEC=3600
METRICS_PORT=9090
OUTBOX_BASE_BACKOFF_MS=1000
```

### 3. Database Backup (PostgreSQL)

**Option A: Via Render Dashboard**
1. Go to Render Dashboard → fastprep-postgres
2. Click "Backups" (if available on your plan)
3. Download latest backup

**Option B: Via pg_dump**
```bash
# Get connection string from Render
# Format: postgresql://user:password@host/database

pg_dump "postgresql://fastprep_admin_4r4k_user:Pm0bIdkJun2KPYurMp186QlIQv6enlFk@dpg-d3skpk2li9vc73alrj70-a.oregon-postgres.render.com/fastprep_admin_4r4k" > backup-$(date +%Y%m%d-%H%M%S).sql
```

**Important Tables:**
- users
- roles
- user_roles
- conversations
- messages
- outbox
- user_permission_overrides
- user_channel_access
- audit_logs
- messenger_connections

### 4. Telegram Session File

**Location:** `/var/data/tdlib/session.txt` on Worker disk

**To backup:**
1. Go to Render Dashboard → fastprep-admin-worker → Shell
2. Run: `cat /var/data/tdlib/session.txt`
3. Copy and save the output to a secure location

**⚠️ CRITICAL:** Without this file, you'll need to re-authenticate Telegram with phone/code/2FA!

---

## Restore Instructions

### 1. Create Render Services
```bash
# Push code to GitHub
git push origin main
git push origin v1.0.0-telegram-working

# Deploy to Render using render.yaml
# Render will automatically create services from the YAML file
```

### 2. Restore Database
```bash
# Get new DATABASE_URL from Render
psql "<new_database_url>" < backup-YYYYMMDD-HHMMSS.sql
```

### 3. Restore Telegram Session
```bash
# In Render Worker Shell:
echo "<session_string>" > /var/data/tdlib/session.txt
```

### 4. Set Environment Variables
- Copy all ENV variables from backup
- Set in Render Dashboard for both API and Worker services

### 5. Restart Services
- Restart both API and Worker on Render

---

## Testing After Restore

1. **Health Check:** `https://fastprep-admin-api.onrender.com/health`
2. **Login:** `https://admin.fastprepusa.com` (user: admin@fastprep.com)
3. **Send Telegram message** to bot
4. **Check Inbox:** Message should appear in UI

---

## Known Issues / Workarounds

### Issue: Worker returns 401 Unauthorized
**Solution:** Ensure `SERVICE_JWT` is identical on both API and Worker, then restart both services.

### Issue: Messages have null text
**Solution:** Already fixed in v1.0.0 - Worker correctly extracts `message.message` field.

### Issue: Global JwtAuthGuard blocks service endpoints
**Solution:** Use `@Public()` decorator on service-to-service endpoints.

---

## Important Notes

- **SERVICE_JWT** must be exactly the same on API and Worker
- **Telegram session** is stored on persistent disk - backup regularly
- **Redis** is ephemeral - data is lost on restart (by design)
- **PostgreSQL** backups depend on your Render plan

---

## Emergency Contacts

- GitHub Repo: https://github.com/maratrubin09-pixel/fastprep-admin
- Render Dashboard: https://dashboard.render.com
- Telegram API: https://my.telegram.org

---

## Version History

- **v1.0.0-telegram-working** (Oct 26, 2025) - Current stable version
  - Telegram integration working
  - Unified Inbox displays messages
  - Service-to-service auth fixed





