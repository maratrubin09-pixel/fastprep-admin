# FastPrep Admin ‚Äî Inbox: –í—Ç–æ—Ä–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–π (9 PR'–æ–≤)

## –ö–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–µ –º–µ–Ω—è—Ç—å):

- **–°—Ç–µ–∫:** NestJS (Node 20), Postgres, Redis, S3/R2, React + MUI
- **TypeScript strict:** `true`
- **EP/PEP:** —É–∂–µ –µ—Å—Ç—å
- **Presigned URLs:** —É–∂–µ –µ—Å—Ç—å
- **–§–∏—á–µ—Ñ–ª–∞–≥:** `FEATURE_INBOX_ENHANCED=true`
- **–¢–∞–π–º–∑–æ–Ω–∞ –≤ UI:** America/New_York (Miami)
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ù–∏—á–µ–≥–æ –Ω–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–∑ PII/—Å–µ–∫—Ä–µ—Ç–æ–≤
- **API:** –í—Å–µ –æ—Ç–≤–µ—Ç—ã —Å–æ —Å—Ö–µ–º–∞–º–∏

---

## PR1 ‚Äî Internal Notes (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏) + WS

### –ë–î (–º–∏–≥—Ä–∞—Ü–∏—è `migrations/2xx_notes.sql`)

```sql
CREATE TABLE IF NOT EXISTS conversation_notes (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id uuid NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
  user_id uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  note_text text NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_notes_conv ON conversation_notes(conversation_id);

/* –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ —Ä–æ–≤–Ω–æ –æ–¥–Ω–∞ –∑–∞–º–µ—Ç–∫–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç–µ ‚Äî —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π: */
/* CREATE UNIQUE INDEX IF NOT EXISTS ux_notes_one_per_user ON conversation_notes(conversation_id, user_id); */
```

### Backend

#### `src/inbox/services/notes.service.ts`

- `get(conversationId, userId)` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –∑–∞–º–µ—Ç–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —á–∞—Ç–∞
- `upsert(conversationId, userId, noteText)` ‚Äî —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
- `remove(conversationId, userId)` ‚Äî —É–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É

#### `src/inbox/controllers/notes.controller.ts`

- `GET /api/inbox/conversations/:id/notes` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –∑–∞–º–µ—Ç–∫—É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `POST /api/inbox/conversations/:id/notes` ‚Äî —Å–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É (upsert)
- `DELETE /api/inbox/conversations/:id/notes` ‚Äî —É–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É

**–ü—Ä–∞–≤–∞:** `inbox.notes.read` / `inbox.notes.write`

#### WebSocket

- `note.upserted` ‚Äî —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏
- `note.deleted` ‚Äî —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏

**–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:** –ü–æ EP –∏ —É—á–∞—Å—Ç–∏—é –≤ —á–∞—Ç–µ (—á–µ—Ä–µ–∑ `canViewThread` –≤ `ws.gateway.ts`)

### Frontend

#### `frontend/src/components/inbox/NotePanel.tsx`

- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ/–ø–∞–Ω–µ–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫
- –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞ —Å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º (debounce ~500ms)
- Markdown preview (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `InboxPage.js`

- –ò–∫–æ–Ω–∫–∞ "–∑–∞–º–µ—Ç–∫–∏" (üìù) –≤ header —á–∞—Ç–∞ ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `NotePanel`
- –õ–æ–∫–∞–ª—å–Ω—ã–π fallback –≤ `localStorage` –Ω–∞ —Å–ª—É—á–∞–π 5xx –æ—à–∏–±–æ–∫
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä, –µ—Å–ª–∏ –∑–∞–º–µ—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

### –ß–µ–∫-–ª–∏—Å—Ç

- [ ] CRUD –∑–∞–º–µ—Ç–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ WS
- [ ] –ù–µ—Ç XSS: sanitize –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏/—Ä–µ–Ω–¥–µ—Ä–µ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DOMPurify –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π)
- [ ] –ü—Ä–∞–≤–∞ —Å–æ–±–ª—é–¥–∞—é—Ç—Å—è (EP –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ backend –∏ —Å–∫—Ä—ã—Ç–∏–µ UI –Ω–∞ frontend)
- [ ] –õ–æ–∫–∞–ª—å–Ω—ã–π fallback —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API

---

## PR2 ‚Äî Pinned Messages (–ø–∏–Ω—ã —Å –ø–æ—Ä—è–¥–∫–æ–º –∏ –ª–∏–º–∏—Ç–æ–º)

### –ë–î (–º–∏–≥—Ä–∞—Ü–∏—è `migrations/2xx_pins.sql`)

```sql
ALTER TABLE messages
  ADD COLUMN IF NOT EXISTS is_pinned boolean NOT NULL DEFAULT false,
  ADD COLUMN IF NOT EXISTS pinned_at timestamptz,
  ADD COLUMN IF NOT EXISTS pinned_by uuid REFERENCES users(id),
  ADD COLUMN IF NOT EXISTS pinned_order smallint;

CREATE UNIQUE INDEX IF NOT EXISTS ux_pinned_order
  ON messages(conversation_id, pinned_order)
  WHERE is_pinned = true;
```

### Backend

#### API Endpoints

- `POST /api/inbox/messages/:id/pin` 
  - Body: `{order?: number}` ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
  - –ê–≤—Ç–æ-–ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ `pinned_order`, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
- `DELETE /api/inbox/messages/:id/pin` ‚Äî –æ—Ç–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
- `GET /api/inbox/conversations/:id/pinned` ‚Äî —Ç–æ–ø-5 –ø–æ `pinned_order ASC`

#### Service –ª–æ–≥–∏–∫–∞

- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ —Å–ª–µ–¥–∏—Ç—å –∑–∞ –º–∞–∫—Å. 5 –ø–∏–Ω–æ–≤ –Ω–∞ —á–∞—Ç
- –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–∫—Ä–µ–ø–∏—Ç—å 6-–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `409 Conflict` —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
- –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∏–Ω–∞ ‚Äî —Å–¥–≤–∏–≥–∞—Ç—å –ø–æ—Ä—è–¥–∫–∏ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø–∏–Ω–æ–≤

**–ü—Ä–∞–≤–∞:** `inbox.pin`

#### WebSocket

- `message.pinned` ‚Äî —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–∏
- `message.unpinned` ‚Äî —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏–∏
- `conversation.updated` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –ø–∏–Ω–æ–≤

### Frontend

#### UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- –ö–Ω–æ–ø–∫–∞ "Pin" (üìå) –≤ action-–º–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏—è (hover actions)
- –°–µ–∫—Ü–∏—è "Pinned" –Ω–∞–¥ —Å–ø–∏—Å–∫–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π
  - –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å –¥–æ 5 –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ `pinned_order ASC`
  - –ü—Ä–∏ –∫–ª–∏–∫–µ ‚Äî –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é –≤ —á–∞—Ç–µ
- Sortable DnD –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º PR)

### –ß–µ–∫-–ª–∏—Å—Ç

- [ ] –ü–∏–Ω—ã —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –∏ —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ
- [ ] –ù–∞ 6-–π –ø–∏–Ω ‚Äî –æ—Ç–∫–∞–∑ —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
- [ ] WS —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç UI —É –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- [ ] –ü—Ä–∏ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏–∏ –ø–æ—Ä—è–¥–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–¥–≤–∏–≥–∞—é—Ç—Å—è

---

## PR3 ‚Äî Media: –±—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä (thumbnails + –∫—É—Ä—Å–æ—Ä–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è)

### –ë–î (–º–∏–≥—Ä–∞—Ü–∏—è `migrations/2xx_media.sql`)

```sql
ALTER TABLE messages
  ADD COLUMN IF NOT EXISTS has_attachments boolean NOT NULL DEFAULT false;

CREATE TABLE IF NOT EXISTS message_media (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  message_id uuid NOT NULL REFERENCES messages(id) ON DELETE CASCADE,
  kind text NOT NULL CHECK (kind IN ('image','video','file','sticker')),
  storage_key text NOT NULL,
  thumb_storage_key text,
  content_type text,
  width int, height int,
  size_bytes int,
  created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_media_msg_kind ON message_media(message_id, kind);
```

### Backend

#### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è thumbnail

- –í –≤–æ—Ä–∫–µ—Ä–µ (–Ω–µ –≤ –∑–∞–ø—Ä–æ—Å–µ) –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ/–ø–æ–ª—É—á–µ–Ω–∏–∏ –º–µ–¥–∏–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Ç–∏–ø–∞ `sharp` –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- Thumbnail —Ä–∞–∑–º–µ—Ä: ~200x200px –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ `thumb_storage_key` –≤ S3/R2

#### API Endpoints

- `GET /api/inbox/conversations/:id/media?kind=image&cursor=&limit=20`
  - –ö—É—Ä—Å–æ—Ä–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è (cursor-based pagination)
  - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: `kind` (image/video/file), `cursor` (ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞), `limit` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20)
- `GET /api/inbox/uploads/thumbnail/:id` 
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç presigned GET URL –Ω–∞ `thumb_storage_key`
  - TTL: 15 –º–∏–Ω—É—Ç

#### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

- –ù–µ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å presigned URL –≤ Redis –¥–æ–ª—å—à–µ TTL
- –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å HEAD/–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–µ–¥–∏–∞ (—Ä–∞–∑–º–µ—Ä, —Ç–∏–ø, dimensions) ‚Äî TTL 1 —á–∞—Å

### Frontend

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- –í–∫–ª–∞–¥–∫–∏ "Photos / Videos / Files" –≤ Media tabs (—É–∂–µ –µ—Å—Ç—å –±–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)
- –í–∏—Ä—Ç—É–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å `react-window` –∏–ª–∏ `react-virtual`
- IntersectionObserver –¥–ª—è lazy loading
- Skeleton placeholders –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ –¥–æ 80%

#### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- Lazy loading –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (`loading="lazy"`)
- Preload –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- Blur-up placeholder –¥–ª—è smooth loading

### –ß–µ–∫-–ª–∏—Å—Ç

- [ ] –õ–∏—Å—Ç–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–æ, –±–µ–∑ "–∑–∞–º–æ—Ä–æ–∑–∫–∏"
- [ ] –ü—Ä–µ–≤—å—é –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ (thumbnails –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –±—ã—Å—Ç—Ä–æ)
- [ ] –°—Å—ã–ª–∫–∏ –Ω–µ –ø—Ä–æ—Ç—É—Ö–∞—é—Ç –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (refresh –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
- [ ] –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–∞—Ö (>100 —ç–ª–µ–º–µ–Ω—Ç–æ–≤)

---

## PR4 ‚Äî Stickers (–∫–∞–Ω–∞–ª-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞)

### –ë–î (–º–∏–≥—Ä–∞—Ü–∏—è `migrations/2xx_stickers.sql`)

```sql
CREATE TABLE IF NOT EXISTS message_stickers (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  message_id uuid NOT NULL REFERENCES messages(id) ON DELETE CASCADE,
  sticker_id text NOT NULL,
  sticker_set_id text,
  emoji text,
  created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_stickers_msg ON message_stickers(message_id);
```

### Backend

#### –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

- –†–∞—Å—à–∏—Ä–∏—Ç—å `InboxService.sendMessage` ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å `stickerId` (–±–µ–∑ –ª–æ–º–∫–∏ —Ç–µ–∫—Å—Ç–∞)
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É: –µ—Å–ª–∏ `stickerId` —É–∫–∞–∑–∞–Ω, `text` –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å caption

#### `TelegramService.sendSticker(conversationId, stickerId)`

- –ò–∑–æ–ª—è—Ü–∏—è –ª–æ–≥–∏–∫–∏ –≤ –∫–∞–Ω–∞–ª–µ Telegram
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Telegram Bot API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∏–∫–µ—Ä–æ–≤
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å `sticker_id` –∏ `sticker_set_id` –≤ –ë–î

#### –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π

- –°—Ç–∏–∫–µ—Ä—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/–≤–∏–¥–µ–æ (–ø–æ –∫–∞–Ω–∞–ª—É)
- –î–ª—è Telegram: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `sticker_id` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

### Frontend

#### `StickerPicker.tsx`

- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–∫–µ—Ä–æ–≤ (—Ä—è–¥–æ–º —Å emoji picker)
- –ú–∏–Ω–∏–º—É–º: –∏–∑–±—Ä–∞–Ω–Ω—ã–µ/–ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∏–∫–µ—Ä—ã
- Grid layout —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
- –î–ª—è Telegram: –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ (–Ω–µ —Å–µ–π—á–∞—Å)

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

- –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É —Å—Ç–∏–∫–µ—Ä–æ–≤ –≤ input toolbar
- –ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Å—Ç–∏–∫–µ—Ä–∞ ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å `stickerId`
- –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Å—Ç–∏–∫–µ—Ä—ã –≤ —Å–ø–∏—Å–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π (–∫–∞–∫ –º–µ–¥–∏–∞)

### –ß–µ–∫-–ª–∏—Å—Ç

- [ ] –°—Ç–∏–∫–µ—Ä —É—Ö–æ–¥–∏—Ç –≤ Telegram –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ UI
- [ ] –ù–µ –ª–æ–º–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –≤ –¥—Ä—É–≥–∏—Ö –∫–∞–Ω–∞–ª–∞—Ö (–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å—Ç–∏–∫–µ—Ä–∞ –≤ –∫–∞–Ω–∞–ª–µ)
- [ ] StickerPicker —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∏–∫–µ—Ä—ã

---

## PR5 ‚Äî Online Status (presence) + last seen

### Backend (Redis-–º–æ–¥–µ–ª—å)

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

```
presence:online (SET userId) ‚Äî –º–Ω–æ–∂–µ—Å—Ç–≤–æ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
presence:lastSeen:{userId} ‚Üí ISO timestamp ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –±—ã–ª –æ–Ω–ª–∞–π–Ω
```

#### WebSocket Gateway

- Heartbeat –∫–∞–∂–¥—ã–µ 60‚Äì120 —Å–µ–∫—É–Ω–¥
- –¢–∞–π–º–∞—É—Ç –æ—Ñ—Ñ–ª–∞–π–Ω ‚Äî 3‚Äì5 –º–∏–Ω—É—Ç (–µ—Å–ª–∏ –Ω–µ—Ç heartbeat ‚Üí —É–¥–∞–ª–∏—Ç—å –∏–∑ SET)
- –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏: –¥–æ–±–∞–≤–∏—Ç—å –≤ `presence:online`, –æ–±–Ω–æ–≤–∏—Ç—å `presence:lastSeen`
- –ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏: —É–¥–∞–ª–∏—Ç—å –∏–∑ `presence:online`, –æ–±–Ω–æ–≤–∏—Ç—å `presence:lastSeen`

#### API Endpoints

- `GET /api/inbox/users/online` ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (IDs)
- `GET /api/inbox/conversations/:id/participants/status` 
  - –°—Ç–∞—Ç—É—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞ (online/offline + last seen)

#### –°–æ–±—ã—Ç–∏—è WebSocket

- `user.online` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–ª –æ–Ω–ª–∞–π–Ω
- `user.offline` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–ª –æ—Ñ—Ñ–ª–∞–π–Ω

### Frontend

#### –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã

- –ó–µ–ª—ë–Ω–∞—è —Ç–æ—á–∫–∞ (üü¢) —É –∞–≤–∞—Ç–∞—Ä–æ–≤ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- "Last seen X min ago" –≤ –ø—Ä–æ—Ñ–∏–ª–µ/header —á–∞—Ç–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ WS —Å–æ–±—ã—Ç–∏—è–º `user.online` / `user.offline`

#### Heartbeat

- –õ–æ–∫–∞–ª—å–Ω—ã–π heartbeat –∫–∞–∂–¥—ã–µ 90 —Å–µ–∫—É–Ω–¥ (emit —á–µ—Ä–µ–∑ WebSocket)
- –û–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç–∞—Ç—É—Å –≤ UI –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏–π

### –ß–µ–∫-–ª–∏—Å—Ç

- [ ] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω ‚â§5 –º–∏–Ω—É—Ç (—Ç–æ—á–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å)
- [ ] –ù–µ—Ç –ª–∏—à–Ω–µ–≥–æ polling (—Ç–æ–ª—å–∫–æ WS + heartbeat)
- [ ] Last seen –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- [ ] Heartbeat –Ω–µ —Å–æ–∑–¥–∞–µ—Ç –ª–∏—à–Ω—é—é –Ω–∞–≥—Ä—É–∑–∫—É

---

## PR6 ‚Äî Last Message Preview (snippets + —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞)

### –ë–î (–º–∏–≥—Ä–∞—Ü–∏—è `migrations/2xx_preview.sql`)

```sql
ALTER TABLE conversations
  ADD COLUMN IF NOT EXISTS last_message_preview text;

CREATE INDEX IF NOT EXISTS idx_conversations_last_message_at
  ON conversations(last_message_at DESC);
```

### Backend

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ preview

- –ü—Ä–∏ –ª—é–±–æ–º –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å `last_message_preview`:
  - HTML ‚Üí text (strip tags)
  - Trimmed –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤
  - Emoji-safe (—Å–æ—Ö—Ä–∞–Ω—è—Ç—å —ç–º–æ–¥–∑–∏)
- –î–ª—è –º–µ–¥–∏–∞ ‚Äî –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–∫–∏: `[Photo]`, `[Video]`, `[File]`, `[Voice]` (–ø–æ–ª–æ–∂–∏—Ç—å –≤ i18n —Å–ª–æ–≤–∞—Ä—å)
- –í —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º `last_message_at`

#### Service –º–µ—Ç–æ–¥

- `InboxService.updateLastMessagePreview(conversationId: string, preview: string)`
- –í—ã–∑—ã–≤–∞—Ç—å –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è

### Frontend

#### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ

- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–≤—å—é –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
- –ñ–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- Ellipsis –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
- –ò–∫–æ–Ω–∫–∏ –¥–ª—è —Ç–∏–ø–æ–≤ –º–µ–¥–∏–∞ ([Photo], [Video], etc.)

#### –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å i18n –¥–ª—è –º–µ—Ç–æ–∫ –º–µ–¥–∏–∞
- –§–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤ preview (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### –ß–µ–∫-–ª–∏—Å—Ç

- [ ] –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ `last_message_at` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ü—Ä–µ–≤—å—é –≤—Å–µ–≥–¥–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
- [ ] –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (i18n –º–µ—Ç–∫–∏)
- [ ] HTML –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ —Ç–µ–∫—Å—Ç

---

## PR7 ‚Äî Mute (–ø–µ—Ä-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

### –ë–î (–º–∏–≥—Ä–∞—Ü–∏—è `migrations/2xx_mute.sql`)

```sql
CREATE TABLE IF NOT EXISTS conversation_user_settings (
  conversation_id uuid NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
  user_id uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  is_muted boolean NOT NULL DEFAULT false,
  muted_until timestamptz,
  PRIMARY KEY (conversation_id, user_id)
);

CREATE INDEX IF NOT EXISTS idx_cus_muted 
  ON conversation_user_settings(is_muted, muted_until);
```

### Backend

#### API Endpoints

- `POST /api/inbox/conversations/:id/mute`
  - Body: `{until?: ISOString}` ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –¥–æ –∫–æ—Ç–æ—Ä–æ–π –º—É—Ç–∏—Ç—å
  - –ï—Å–ª–∏ `until` –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –º—É—Ç–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞
- `POST /api/inbox/conversations/:id/unmute` ‚Äî –≤–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `GET /api/inbox/conversations/:id/settings` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### Service –º–µ—Ç–æ–¥—ã

- `InboxService.muteConversation(conversationId: string, userId: string, until?: Date)`
- `InboxService.unmuteConversation(conversationId: string, userId: string)`
- `InboxService.isConversationMuted(conversationId: string, userId: string): Promise<boolean>`
- –ê–≤—Ç–æ-—Ä–∞–∑–º—É—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥)

#### Cron –∑–∞–¥–∞—á–∞

- –ü—Ä–æ–≤–µ—Ä–∫–∞ `muted_until` –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º—É—Ç –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –¥–∞—Ç—ã

### Frontend

#### UI

- –ò–∫–æ–Ω–∫–∞ "Mute" (üîá) –≤ header —á–∞—Ç–∞
- –ú–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ:
  - "Mute for 1 hour"
  - "Mute for 8 hours"
  - "Mute until tomorrow"
  - "Mute forever"
  - "Unmute" (–µ—Å–ª–∏ —É–∂–µ –∑–∞–º—É—á–µ–Ω)
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "muted" (üîá) –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤ –¥–ª—è –∑–∞–≥–ª—É—à–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤

#### –õ–æ–≥–∏–∫–∞

- –†–∞–∑–º—É—Ç –ø—Ä–∏ —Å–≤–æ—ë–º —Å–æ–æ–±—â–µ–Ω–∏–∏ ‚Äî –µ—Å–ª–∏ –≤–∫–ª—é—á–∏–º –æ–ø—Ü–∏—é

### –ß–µ–∫-–ª–∏—Å—Ç

- [ ] –ú—É—Ç/–∞–Ω–º—É—Ç –Ω–µ –º–µ—à–∞—é—Ç –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–ø–µ—Ä-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
- [ ] –í—Ä–µ–º–µ–Ω–Ω—ã–π –º—É—Ç —Å–Ω–∏–º–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- [ ] UI –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –º—É—Ç–∞
- [ ] –ê–≤—Ç–æ-—Ä–∞–∑–º—É—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)

---

## PR8 ‚Äî Profile View (–ø—Ä–æ—Ñ–∏–ª—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞)

### –ë–î (–º–∏–≥—Ä–∞—Ü–∏—è `migrations/2xx_profile.sql`)

```sql
ALTER TABLE conversations
  ADD COLUMN IF NOT EXISTS sender_photo_url text,
  ADD COLUMN IF NOT EXISTS sender_bio text,
  ADD COLUMN IF NOT EXISTS sender_verified boolean DEFAULT false;
```

### Backend

#### API Endpoints

- `GET /api/inbox/conversations/:id/profile` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
- `PUT /api/inbox/conversations/:id/profile` ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–æ—Ñ–∏–ª—è (admin-only)
- –î–ª—è Telegram: `GET /api/inbox/telegram/users/:peerId` 
  - –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ Telegram API
  - –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å 1‚Äì5 –º–∏–Ω—É—Ç –≤ Redis

#### Service –º–µ—Ç–æ–¥—ã

- `InboxService.getConversationProfile(conversationId: string)`
- `InboxService.updateConversationProfile(conversationId: string, profileData: any)` ‚Äî admin only
- `TelegramService.getUserProfile(peerId: string)` ‚Äî –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ Telegram

#### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

- –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ Telegram –≤ Redis (TTL 5 –º–∏–Ω—É—Ç)
- –ö–ª—é—á: `telegram:profile:{peerId}`

### Frontend

#### `ProfileModal.tsx`

- –ë–æ–ª—å—à–æ–π –∞–≤–∞—Ç–∞—Ä (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ fullscreen)
- –ò–º—è, username, —Ç–µ–ª–µ—Ñ–æ–Ω
- Bio/–æ–ø–∏—Å–∞–Ω–∏–µ
- Verified badge (–µ—Å–ª–∏ `sender_verified = true`)
- Last seen (–∏–∑ presence —Å–∏—Å—Ç–µ–º—ã)
- –°—á—ë—Ç—á–∏–∫–∏:
  - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ
  - –î–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  - –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –î–µ–π—Å—Ç–≤–∏—è (–ø–æ–∫–∞ –∫–Ω–æ–ø–∫–∏-–∑–∞–≥–ª—É—à–∫–∏, –µ—Å–ª–∏ –Ω–µ—Ç –ª–æ–≥–∏–∫–∏):
  - "Block user"
  - "Report"
  - "Clear chat history"

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

- –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∞–≤–∞—Ç–∞—Ä –≤ header —á–∞—Ç–∞ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞—Ç—å `ProfileModal`
- –î–ª—è Telegram: –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (verified badge, etc.)

### –ß–µ–∫-–ª–∏—Å—Ç

- [ ] –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–æ, –∫—ç—à –≤–∏–¥–Ω–æ –ø–æ –ª–æ–≥–∞–º
- [ ] –ù–µ—Ç "—Å–ø–∞–º–∞" –≤–Ω–µ—à–Ω–∏—Ö API (–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
- [ ] –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
- [ ] Verified badge –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## PR9 ‚Äî WS, –ø—Ä–∞–≤–∞, –ø–æ–ª–∏—Ä–æ–≤–∫–∞, –º–µ—Ç—Ä–∏–∫–∏

### WebSocket —Å–æ–±—ã—Ç–∏—è (–¥–æ–±–∞–≤–∏—Ç—å –≤ `ws.gateway.ts`)

#### –ù–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è

- `note.upserted` ‚Äî –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏
- `note.deleted` ‚Äî –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏
- `message.pinned` ‚Äî –ø—Ä–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
- `message.unpinned` ‚Äî –ø—Ä–∏ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
- `conversation.updated` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ preview/mute/pins
- `user.online` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–ª –æ–Ω–ª–∞–π–Ω
- `user.offline` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–ª –æ—Ñ—Ñ–ª–∞–π–Ω

#### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è

- –í—Å–µ —Å–æ–±—ã—Ç–∏—è ‚Äî —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ EP –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é/–∫–∞–Ω–∞–ª–∞–º –≤ O(1)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É `canViewThread` –≤ `ws.gateway.ts`
- Redis-–∫–ª—é—á–∏: `inbox:assignee:*`, `inbox:unassigned`

### –ü—Ä–∞–≤–∞

#### –ù–æ–≤—ã–µ –ø—Ä–∞–≤–∞ (–≤–≤–µ—Å—Ç–∏ –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å)

- `inbox.notes.read` ‚Äî —á—Ç–µ–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫
- `inbox.notes.write` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫
- `inbox.pin` ‚Äî –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- `inbox.media.read` ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –º–µ–¥–∏–∞
- `inbox.mute` ‚Äî –º—É—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Ç–æ–≤
- `inbox.profile.read` ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª–µ–π
- `inbox.profile.manage` ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π (admin)

#### Frontend

- –°–∫—Ä—ã–≤–∞—Ç—å UI-–¥–µ–π—Å—Ç–≤–∏—è –±–µ–∑ –ø—Ä–∞–≤ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ EP –Ω–∞ frontend)
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å disabled —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π

### –ú–µ—Ç—Ä–∏–∫–∏/–∞–ª–µ—Ä—Ç—ã (prom-client)

#### –ú–µ—Ç—Ä–∏–∫–∏

```typescript
// –°—á–µ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
ws_events_emitted_total{type} ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö WS —Å–æ–±—ã—Ç–∏–π –ø–æ —Ç–∏–ø—É

// –°—á–µ—Ç—á–∏–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
notes_upsert_total ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö/–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫
pins_total ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
media_thumbs_generated_total ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö thumbnails

// Gauge –º–µ—Ç—Ä–∏–∫–∏
presence_online_users_gauge ‚Äî —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```

#### –ê–ª–µ—Ä—Ç—ã

1. **Bursts 5xx –Ω–∞ API**
   - –ê–ª–µ—Ä—Ç –ø—Ä–∏ >10 5xx –æ—à–∏–±–æ–∫ –∑–∞ 1 –º–∏–Ω—É—Ç—É –Ω–∞ –ª—é–±–æ–º endpoint

2. **–†–æ—Å—Ç –æ—á–µ—Ä–µ–¥–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ thumbnails**
   - –ê–ª–µ—Ä—Ç –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å >100 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—á–µ—Ä–µ–¥—å)

3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ WS-—Å–æ–±—ã—Ç–∏–π > N –º–∏–Ω—É—Ç**
   - –ê–ª–µ—Ä—Ç –µ—Å–ª–∏ –Ω–µ—Ç WS —Å–æ–±—ã—Ç–∏–π >5 –º–∏–Ω—É—Ç (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã)

### –ß–µ–∫-–ª–∏—Å—Ç (—Ñ–∏–Ω–∞–ª)

- [ ] –í—Å–µ 8 –±–ª–æ–∫–æ–≤ (PR1-PR8) –ø—Ä–æ—Ö–æ–¥—è—Ç e2e —Ç–µ—Å—Ç—ã
- [ ] –ù–µ—Ç XSS/—É—Ç–µ—á–µ–∫, TypeScript strict –∑–µ–ª—ë–Ω—ã–π
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ —Ç–∏–∫–∞—é—Ç, –∞–ª–µ—Ä—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
- [ ] WS —Å–æ–±—ã—Ç–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è
- [ ] –ü—Ä–∞–≤–∞ —Å–æ–±–ª—é–¥–∞—é—Ç—Å—è –≤–µ–∑–¥–µ (backend + frontend)
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (API endpoints, –ø—Ä–∞–≤–∞)

---

## –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ –≤—Å–µ PR

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **TypeScript strict: true**
   - –ù–∏–∫–∞–∫–∏—Ö "—Ç–∏—Ö–∏—Ö" –æ—Ç–∫–ª—é—á–µ–Ω–∏–π —Å—Ç—Ä–æ–≥–∏—Ö –ø—Ä–∞–≤–∏–ª TS
   - –í—Å–µ —Ç–∏–ø—ã —è–≤–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã

2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
   - –ù–µ—Ç XSS: sanitize –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º/—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º
   - –ù–µ—Ç —É—Ç–µ—á–µ–∫ PII –≤ –ª–æ–≥–∞—Ö
   - –í—Å–µ –ø—Ä–∞–≤–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ backend

3. **WebSocket**
   - –¢–æ–ª—å–∫–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–±—ã—Ç–∏—è
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É `canViewThread`

4. **–î–∞—Ç—ã**
   - –í—Å–µ –¥–∞—Ç—ã –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ –ø–æ–º–µ—á–∞–µ–º ET (tooltip ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `date-fns-tz` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–µ

5. **API**
   - –í—Å–µ –æ—Ç–≤–µ—Ç—ã API —Å–æ —Å—Ö–µ–º–∞–º–∏ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å class-validator, Swagger)
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- –ö–∞–∂–¥—ã–π PR: –∫–æ—Ä–æ—Ç–∫–æ–µ README –≤ –∫–æ—Ä–Ω–µ PR ‚Äî "—á—Ç–æ —Å–¥–µ–ª–∞–Ω–æ / –∫–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å / —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –∏–ª–∏ gif"
- –ö–æ–º–º–∏—Ç—ã: –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- Unit-—Ç–µ—Å—Ç—ã –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã –∏ –ø–∞—Ä—Å–µ—Ä—ã
- E2E –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ –ø–æ—Ç–æ–∫–∏
- –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ PR –ø—Ä–∏–ª–æ–∂–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã UI –∏ –∫–æ—Ä–æ—Ç–∫–∏–π –ª–æ–≥ e2e-–ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —á–µ–∫-–ª–∏—Å—Ç–æ–≤

### –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

**–°–¥–µ–ª–∞–π PR'—ã —Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ—Ä—è–¥–∫—É PR1 ‚Üí PR9.** –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ PR:
- –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –ø—Ä–µ–¥—ã–¥—É—â–∏–π PR –Ω–µ —Å–ª–æ–º–∞–ª—Å—è
- –ü—Ä–∏–ª–æ–∂–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã UI
- –ü—Ä–∏–ª–æ–∂–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –ª–æ–≥ e2e-–ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —á–µ–∫-–ª–∏—Å—Ç–æ–≤
- –£–±–µ–¥–∏—Å—å —á—Ç–æ TypeScript –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

---

## Checklist –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é –≤—Å–µ—Ö PR

- [ ] –í—Å–µ 9 PR'–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –∏ –∑–∞–º–µ—Ä–∂–µ–Ω—ã
- [ ] –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –≤ production
- [ ] –í—Å–µ e2e —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ê–ª–µ—Ä—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] Code review –ø—Ä–æ–π–¥–µ–Ω
- [ ] Production deployment —É—Å–ø–µ—à–µ–Ω

